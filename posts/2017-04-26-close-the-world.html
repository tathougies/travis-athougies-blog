<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
        <title>Travis Athougies - Close the world</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
        <link rel="stylesheet" type="text/css" href="../css/jquery.modal.css" />
        <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,800,700" rel="stylesheet" type="text/css">
        <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/javascript" src="../js/jquery.min.js"></script>
        <script type"text javascript" src="../js/jquery.modal.min.js"></script>
	<script type="text/javascript" src="../js/isotope.min.js"></script>
	<script type="text/javascript" src="../js/imagesloaded.min.js"></script>
        <script type="text/javascript" src="../js/gallery.js"></script>
    </head>
    <body>
        <div id="mini-header-bar">
          <div id="show-header">
            ☰
          </div>
          <h1 id="mini-logo">
            <a href="../"><p class="travis">Travis</p><p>Athougies</p></a>
          </h1>
        </div>
        <div id="gallery-modal" class="modal" style="display: hidden">
          <a href="#" id="gallery-prev"></a>
          <a href="#" id="gallery-next"></a>
          <img id="gallery-image" src="#" />
          <div id="gallery-caption">
            <span class="gallery-figure">Figure <span id="figure-number">0</span> &mdash;</span><span id="caption-text"></span>
          </div>
        </div>
        <div id="header">
            <h1 id="logo">
                <a href="../"><p class="travis">Travis</p><p>Athougies</p></a>
            </h1>
            <div id="taglines">
              technologist
              dreamer
              builder
            </div>
            <ul id="navigation">
              <li><h2>Navigation</h2>
                <ul>
                  <li><a href="../">Home</a></li>
                  <li><a href="../about.html">About</a></li>
                  <li><a href="../projects.html">Projects</a></li>
                  <li><a href="../contact.html">Contact</a></li>
                  <li><a href="../archive.html">Archive</a></li>
                </ul></li>
              <li><h2>Tags</h2>
                <ul>
                
                  <li><a href="../tags/haskell.html">haskell (14)</a></li>
                
                  <li><a href="../tags/hydroponics.html">hydroponics (9)</a></li>
                
                  <li><a href="../tags/sustainability.html">sustainability (5)</a></li>
                
                  <li><a href="../tags/gardening.html">gardening (4)</a></li>
                
                  <li><a href="../tags/beam.html">beam (3)</a></li>
                
                  <li><a href="../tags/web.html">web (2)</a></li>
                
                  <li><a href="../tags/math.html">math (2)</a></li>
                
                  <li><a href="../tags/hakyll.html">hakyll (1)</a></li>
                
                  <li><a href="../tags/food.html">food (1)</a></li>
                
                  <li><a href="../tags/finance.html">finance (1)</a></li>
                
                  <li><a href="../tags/databases.html">databases (1)</a></li>
                
                  <li><a href="../tags/business.html">business (1)</a></li>
                
                  <li><a href="../tags/agriculture.html">agriculture (1)</a></li>
                </ul></li>
            </ul>
          <div id="shamelessplug">
              Site proudly generated by
              <a href="http://jaspervdj.be/hakyll">Hakyll</a> <p></p>
              This site kept updated by <a href="http://travis-ci.org">Travis CI</a> <p></p>
              <img src="https://travis-ci.org/tathougies/travis-athougies-blog.svg?branch=master" />
          </div>
        </div>

        <div id="content">
            <h1>Close the world</h1>

            <div class="info">
    Posted on <span class="date">April 26, 2017</span>
    
        by <span class="author">Travis Athougies</span>
    
</div>
<div class="tags">
  in
  <ul>
    
    <li><a href="../tags/haskell.html">haskell</a></li>
    
  </ul>
</div>



<div id="post">
<p>Haskell’s polymorphism is awesome for writing generic code.</p>
<p>In particular, Haskell’s typeclass mechanism allows you to write code that works over any type that implements certain functionality. Haskell’s GADT support allows you to hold references to values where you know nothing about the type, except the functionality it exports. The <code>-XConstraintKinds</code> feature allows us to be polymorphic over not only types but the constraints on those types as well. For example, the following type carries around the constraint parameter to the type and exposes it when the constructor is matched upon.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">data</span> <span class="dt">Dict</span> c <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2">  <span class="dt">Dict</span><span class="ot"> ::</span> c <span class="ot">=&gt;</span> <span class="dt">Dict</span> c</a></code></pre></div>
<p>Another awesome feature is Haskell’s <code>Typeable</code> mechanism, which allows us to ‘forget’ about types at compile time and recover them safely at run-time. In particular, you can do something like</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">data</span> <span class="dt">MyDynamic</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">  <span class="dt">MyDynamic</span><span class="ot"> ::</span> <span class="dt">Typeable</span> a <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">MyDynamic</span></a></code></pre></div>
<p>Here, <code>MyDynamic</code> can be used to store any Haskell type. When we want to use the value, we can use <code>Data.Typeable.cast</code> to get a value of a certain type, but <em>only if that value had the type we wanted to begin with</em>. This is type-safe, so there’s no risk of seg faulting. This works because GHC always knows the type passed to <code>MyDynamic</code> when the value is created. The <code>Typeable a</code> constraint in the constructor causes GHC to not only store the value of type <code>a</code> in the constructor, but also the ‘dictionary’ representing the implementation of the <code>Typeable</code> instance for <code>a</code>.</p>
<p>Now, for example, if we had a list of <code>MyDynamic</code></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co">-- The explicit type annotations are necessary so GHC knows what 'Typeable' dictionary to include</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="ot">myList ::</span> [<span class="dt">MyDynamic</span>]</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">myList <span class="fu">=</span> [ <span class="dt">MyDynamic</span> (<span class="dv">5</span><span class="ot"> ::</span> <span class="dt">Int</span>), <span class="dt">MyDynamic</span> (<span class="dv">6</span><span class="ot"> ::</span> <span class="dt">Integer</span>), <span class="dt">MyDynamic</span> (<span class="st">&quot;Hello world&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>), <span class="dt">MyDynamic</span> (<span class="dt">Nothing</span><span class="ot"> ::</span> <span class="dt">Maybe</span> <span class="dt">Int</span>) ]</a></code></pre></div>
<p>We can define a function</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="ot">only ::</span> forall a<span class="fu">.</span> <span class="dt">Typeable</span> a <span class="ot">=&gt;</span> [<span class="dt">MyDynamic</span>] <span class="ot">-&gt;</span> [a]</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">only <span class="fu">=</span> mapMaybe (\(<span class="dt">MyDynamic</span> x) <span class="ot">-&gt;</span> cast x)</a></code></pre></div>
<p>Now, we can ask GHC for only the <code>Int</code> values in <code>myList</code></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" data-line-number="1">only <span class="fu">@</span><span class="dt">Int</span> myList <span class="fu">==</span> [ <span class="dv">5</span> ] </a></code></pre></div>
<p>Or, the <code>Integer</code></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" data-line-number="1">only <span class="fu">@</span><span class="dt">Integer</span> myList <span class="fu">=</span> [ <span class="dv">6</span> ]</a></code></pre></div>
<h2 id="enter-polymorphism">Enter polymorphism</h2>
<p>This is awesome, but suppose you wanted to write a function that could increment a list containing values of any type that implemented <code>Num</code>. You would like this list to be able to hold different types. For example, perhaps you had the following list.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="ot">myNumList ::</span> [ <span class="dt">MyDynamic</span> ]</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">myNumList <span class="fu">=</span> [ <span class="dt">MyDynamic</span> (<span class="dv">1</span><span class="ot"> ::</span> <span class="dt">Int</span>), <span class="dt">MyDynamic</span> (<span class="dv">2</span><span class="ot"> ::</span> <span class="dt">Double</span>), <span class="dt">MyDynamic</span> (<span class="dv">3</span><span class="ot"> ::</span> <span class="dt">Integer</span>) ]</a></code></pre></div>
<p>We would like to write.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="ot">incrementAll ::</span> [<span class="dt">MyDynamic</span>] <span class="ot">-&gt;</span> [<span class="dt">MyDynamic</span>]</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">incrementAll <span class="fu">=</span> map (\(<span class="dt">MyDynamic</span> a) <span class="ot">-&gt;</span> <span class="dt">MyDynamic</span> (maybe a (<span class="fu">+</span><span class="dv">1</span>) (cast a)))</a></code></pre></div>
<p>However, if you compile this, you will get an error about ambiguous types. You could try giving a type to <code>1</code> or <code>cast</code>, but, if you do, this function will only increment values of that type. For example, if you substituted <code>cast a</code> for <code>cast a :: Maybe Int</code>, <code>incrementAll myNumList</code> would yield <code>[MyDynamic (2 :: Int), MyDynamic (2 :: Double), MyDynamic (3 :: Integer)]</code>. That’s not very useful.</p>
<p>This is moderately annoying. It seems like <code>Typeable</code> ought to give us enough information to figure this out, but alas, <code>Typeable</code> doesn’t magically make Haskell a dynamic language.</p>
<p>It would be awesome if we could write a function like <code>cast</code> that let us operate on a value as long as its type fulfilled certain constraints. That is,</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="ot">withConstraint ::</span> forall (<span class="ot">c ::</span> <span class="fu">*</span> <span class="ot">-&gt;</span> <span class="dt">Constraint</span>) r<span class="fu">.</span> <span class="dt">MyDynamic</span> <span class="ot">-&gt;</span> r <span class="ot">-&gt;</span> (forall a<span class="fu">.</span> (<span class="dt">Typeable</span> a, c a) <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> r) <span class="ot">-&gt;</span> r</a></code></pre></div>
<p>This function says takes a constraint over a single type parameter, a <code>MyDynamic</code>, a default result, and a function that can produce an <code>r</code>, given any <code>a</code> that satisfies the constraint. It returns the first <code>r</code> if the value in the <code>MyDynamic</code> doesn’t satisfy constraint <code>c</code>. If the value does satisfy <code>c</code>, then it passes that value to the given function and returns that value instead. If we had <code>withConstraint</code>, we can write <code>incrementAll</code> as</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="ot">incrementAll ::</span> [ <span class="dt">MyDynamic</span> ] <span class="ot">-&gt;</span> [ <span class="dt">MyDynamic</span> ]</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">incrementAll <span class="fu">=</span> map (\d <span class="ot">-&gt;</span> withConstraint <span class="fu">@</span><span class="dt">Num</span> d d (\x <span class="ot">-&gt;</span> <span class="dt">MyDynamic</span> (x <span class="fu">+</span> <span class="dv">1</span>)))</a></code></pre></div>
<h2 id="the-world-is-too-open">The world is too open</h2>
<p>It turns out we can’t write <code>withConstraint</code> in its general form. For one thing, the set of instances available can change at run-time. Its not common, but Haskell code could potentially load a plugin at run-time. Thus, an instance for <code>Num x</code> may be introduced at run-time. Additionally, such run-time loading could introduce incoherent instances. Thus, any <code>withConstraint</code> function would have to be written in <code>IO</code>, so it could observe this global state.</p>
<p>However, the following function can still be written.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="ot">forMyNums ::</span> <span class="dt">MyDynamic</span> <span class="ot">-&gt;</span> r <span class="ot">-&gt;</span> (forall a<span class="fu">.</span> (<span class="dt">Typeable</span> a, <span class="dt">Num</span> a) <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> r) <span class="ot">-&gt;</span> r</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">forMyNums (<span class="dt">MyDynamic</span> x) def fn <span class="fu">=</span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3">  fromMaybe def <span class="fu">$</span> tryInt <span class="fu">&lt;|&gt;</span> tryDouble <span class="fu">&lt;|&gt;</span> tryInteger</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5">    tryInt <span class="fu">=</span> <span class="kw">case</span> cast x <span class="kw">of</span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6">               <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7">               <span class="dt">Just</span> (<span class="ot">x ::</span> <span class="dt">Int</span>) <span class="ot">-&gt;</span> <span class="dt">Just</span> (fn x) <span class="co">-- Here, GHC knows 'x' has type 'Int', and it knows a 'Num Int' instance exists</span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8">    tryDouble <span class="fu">=</span> <span class="kw">case</span> cast x <span class="kw">of</span></a>
<a class="sourceLine" id="cb11-9" data-line-number="9">                  <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb11-10" data-line-number="10">                  <span class="dt">Just</span> (<span class="ot">x ::</span> <span class="dt">Double</span>) <span class="ot">-&gt;</span> <span class="dt">Just</span> (fn x)</a>
<a class="sourceLine" id="cb11-11" data-line-number="11">    tryInteger <span class="fu">=</span> <span class="kw">case</span> cast x <span class="kw">of</span></a>
<a class="sourceLine" id="cb11-12" data-line-number="12">                   <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb11-13" data-line-number="13">                   <span class="dt">Just</span> (<span class="ot">x ::</span> <span class="dt">Integer</span>) <span class="ot">-&gt;</span> <span class="dt">Just</span> (fn x)</a></code></pre></div>
<p>We can simplify this a bit more too.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="ot">tryNum ::</span> forall a x<span class="fu">.</span> (<span class="dt">Typeable</span> x, <span class="dt">Typeable</span> a, <span class="dt">Num</span> a) <span class="ot">=&gt;</span> x <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">tryNum x <span class="fu">=</span> cast x</a>
<a class="sourceLine" id="cb12-3" data-line-number="3"></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="ot">forMyNums ::</span> <span class="dt">MyDynamic</span> <span class="ot">-&gt;</span> r <span class="ot">-&gt;</span> (forall a<span class="fu">.</span> (<span class="dt">Typeable</span> a, <span class="dt">Num</span> a) <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> r) <span class="ot">-&gt;</span> r</a>
<a class="sourceLine" id="cb12-5" data-line-number="5">forMyNums (<span class="dt">MyDynamic</span> x) def fn <span class="fu">=</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6">  fromMaybe def <span class="fu">$</span> fmap fn (tryNum <span class="fu">@</span><span class="dt">Int</span> x) <span class="fu">&lt;|&gt;</span> fmap fn (tryNum <span class="fu">@</span><span class="dt">Double</span> x) <span class="fu">&lt;|&gt;</span> fmap fn (tryNum <span class="fu">@</span><span class="dt">Integer</span> x)</a></code></pre></div>
<p>And we can generalize even this!</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="ot">tryHead ::</span> forall c a x<span class="fu">.</span> (<span class="dt">Typeable</span> x, <span class="dt">Typeable</span> a, c a) <span class="ot">=&gt;</span> x <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">tryHead x <span class="fu">=</span> cast x</a>
<a class="sourceLine" id="cb13-3" data-line-number="3"></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="ot">withHead ::</span> forall c r<span class="fu">.</span> (c <span class="dt">Double</span>, c <span class="dt">Int</span>, c <span class="dt">Integer</span>) <span class="ot">=&gt;</span> <span class="dt">MyDynamic</span> <span class="ot">-&gt;</span> r <span class="ot">-&gt;</span> (forall a<span class="fu">.</span> (<span class="dt">Typeable</span> a, c a) <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> r) <span class="ot">-&gt;</span> r</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">withHead (<span class="dt">MyDynamic</span> x) def fn <span class="fu">=</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6">  fromMaybe def <span class="fu">$</span> fmap fn (tryHead <span class="fu">@</span>c <span class="fu">@</span><span class="dt">Int</span> x) <span class="fu">&lt;|&gt;</span> fmap fn (tryHead <span class="fu">@</span>c <span class="fu">@</span><span class="dt">Double</span> x) <span class="fu">&lt;|&gt;</span> fmap fn (tryHead <span class="fu">@</span>c <span class="fu">@</span><span class="dt">Integer</span> x)</a></code></pre></div>
<p>Now <code>forMyNums = withHead @Num</code>. Of course, this only works if our types in the <code>MyDynamic</code> are <code>Int</code>, <code>Double</code>, or <code>Integer</code>. If we were to add a <code>MyDynamic (x :: Float)</code>, it would not be incremented. However, it does show something important: <em>if we limit ourselves to certain types, what we wanted becomes possible</em>.</p>
<p>Additionally, what should be immediately clear here is that adding another type to our universe of types, is very mechanical. To add <code>Float</code>, just add another alternative in our <code>(&lt;|&gt;)</code> chain. In fact, it seems like these cast attempts combine monoidally.</p>
<h2 id="the-closed-world-package">The <code>closed-world</code> package</h2>
<p>The <a href="https://github.com/tathougies/closed-world"><code>closed-world</code></a> package takes this idea to its logical extreme. It provides a type <code>Universe</code> that can hold any set of coherent instances. Not only can <code>Universe</code> hold concrete instances as we showed above, it can also hold instance constructors. For example, while <code>Show Int</code> is a concrete instance <code>Show (a, b)</code> is an ‘instance constructor’. It says that, given an instance for <code>Show a</code> and one for <code>Show b</code>, I can construct such an instance for <code>Show (a, b)</code>.</p>
<p>Because <code>Universe</code>s are like any Haskell value, it can only be constructed at some pure point in the program’s execution. At any particular point in a Haskell program, the compiler knows that the set of applying instances is indeed coherent (unless some very nasty compiler extensions are being turned on). This gets around the problems identified above where the ‘global’ set of instances may be incoherent.</p>
<p><code>closed-world</code> provides a function <code>withHead</code> that looks like what we wrote above, except it also takes a <code>Universe</code> parameter identifying the full set of instances to use.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="ot">withHead ::</span> forall cs a<span class="fu">.</span> <span class="dt">Typeable</span> cs <span class="ot">=&gt;</span> <span class="dt">Universe</span> <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> (cs <span class="ot">=&gt;</span> a) <span class="ot">-&gt;</span> a</a></code></pre></div>
<p>Now, if you have a value</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="ot">myList ::</span> [<span class="dt">MyDynamic</span>]</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">myList <span class="fu">=</span> [ <span class="dt">MyDynamic</span> (<span class="dv">1</span><span class="ot"> ::</span> <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">         , <span class="dt">MyDynamic</span> (<span class="st">&quot;hello world&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">         , <span class="dt">MyDynamic</span> ((<span class="st">&quot;hello&quot;</span>, <span class="dv">3</span>)<span class="ot"> ::</span> (<span class="dt">String</span>, <span class="dt">Int</span>))</a>
<a class="sourceLine" id="cb15-5" data-line-number="5">         , <span class="dt">MyDynamic</span> ((<span class="st">&quot;hello&quot;</span>, <span class="st">&quot;world&quot;</span>)<span class="ot"> ::</span> (<span class="dt">String</span>, <span class="dt">String</span>))</a>
<a class="sourceLine" id="cb15-6" data-line-number="6">         , <span class="dt">MyDynamic</span> (<span class="dt">Nothing</span><span class="ot"> ::</span> <span class="dt">Maybe</span> <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb15-7" data-line-number="7">         , <span class="dt">MyDynamic</span> (<span class="dt">Just</span> <span class="dv">34</span><span class="ot"> ::</span> <span class="dt">Maybe</span> <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb15-8" data-line-number="8">         , <span class="dt">MyDynamic</span> (<span class="dt">Just</span> (<span class="st">&quot;hello, world&quot;</span>, <span class="dv">4</span>)<span class="ot"> ::</span> <span class="dt">Maybe</span> (<span class="dt">String</span>, <span class="dt">Int</span>))</a>
<a class="sourceLine" id="cb15-9" data-line-number="9">         , <span class="dt">MyDynamic</span> ([<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>]<span class="ot"> ::</span> [<span class="dt">Int</span>])</a>
<a class="sourceLine" id="cb15-10" data-line-number="10">         , <span class="dt">MyDynamic</span> ([<span class="st">&quot;hello&quot;</span>, <span class="st">&quot;world&quot;</span>]<span class="ot"> ::</span> [<span class="dt">String</span>]) ]</a></code></pre></div>
<p>You can specify a set of instances to use (you’ll need Template Haskell)</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="ot">showIntInstance ::</span> <span class="dt">Universe</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2">showIntInstance <span class="fu">=</span> <span class="fu">$</span>(mkUniverse [d| instance Show Int |])</a>
<a class="sourceLine" id="cb16-3" data-line-number="3"></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="ot">showCharInstance ::</span> <span class="dt">Universe</span></a>
<a class="sourceLine" id="cb16-5" data-line-number="5">showCharInstance <span class="fu">=</span> <span class="fu">$</span>(mkUniverse [d| instance Show Char |])</a>
<a class="sourceLine" id="cb16-6" data-line-number="6"></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"><span class="co">-- Universes combine monoidally</span></a>
<a class="sourceLine" id="cb16-8" data-line-number="8"><span class="ot">simpleShowInstances ::</span> <span class="dt">Universe</span></a>
<a class="sourceLine" id="cb16-9" data-line-number="9">simpleShowInstances <span class="fu">=</span> showIntInstance <span class="fu">&lt;&gt;</span> showCharInstance</a>
<a class="sourceLine" id="cb16-10" data-line-number="10"></a>
<a class="sourceLine" id="cb16-11" data-line-number="11"><span class="co">-- mkUniverse can also take a whole set of instance declarations</span></a>
<a class="sourceLine" id="cb16-12" data-line-number="12"><span class="ot">compoundShowInstances ::</span> <span class="dt">Universe</span></a>
<a class="sourceLine" id="cb16-13" data-line-number="13">compoundShowInstances <span class="fu">=</span> <span class="fu">$</span>(mkUniverse [d| instance Show a =&gt; Show [a] </a>
<a class="sourceLine" id="cb16-14" data-line-number="14">                                         instance (Show a, Show b) =&gt; Show (a, b)</a>
<a class="sourceLine" id="cb16-15" data-line-number="15">                                         instance Show a =&gt; Show (Maybe a) |])</a></code></pre></div>
<p>And now,</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb17-1" data-line-number="1">fmap (\(<span class="dt">MyDynamic</span> (<span class="ot">x ::</span> a)) <span class="ot">-&gt;</span> withHead <span class="fu">@</span>(<span class="dt">Show</span> a) u <span class="dt">Nothing</span> (<span class="dt">Just</span> <span class="fu">$</span> show x)) myList</a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="co">-- Yields [Just &quot;1&quot;,Just &quot;\&quot;hello world\&quot;&quot;,Just &quot;(\&quot;hello\&quot;,3)&quot;,Just &quot;(\&quot;hello\&quot;,\&quot;world\&quot;)&quot;,Just &quot;Nothing&quot;,Just &quot;Just 34&quot;,Just &quot;Just (\&quot;hello, world\&quot;,4)&quot;,Just &quot;[1,2,3,4,5]&quot;,Just &quot;[\&quot;hello\&quot;,\&quot;world\&quot;]&quot;]</span></a></code></pre></div>
<p><code>closed-world</code> is available on github, and there is more documentation there. I’ll cover more about the internals in a later post.</p>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'travisathougiessblog'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

        </div>
        <!-- Google Analytics Tracking -->
        <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-55204994-1', 'auto');
        ga('send', 'pageview');

        </script>
    </body>
</html>
