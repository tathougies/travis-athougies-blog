<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
        <title>Travis Athougies - Fun with Haskell</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
        <link rel="stylesheet" type="text/css" href="../css/jquery.modal.css" />
        <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,800,700" rel="stylesheet" type="text/css">
        <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/javascript" src="../js/jquery.min.js"></script>
        <script type"text javascript" src="../js/jquery.modal.min.js"></script>
	<script type="text/javascript" src="../js/isotope.min.js"></script>
	<script type="text/javascript" src="../js/imagesloaded.min.js"></script>
        <script type="text/javascript" src="../js/gallery.js"></script>
    </head>
    <body>
        <div id="mini-header-bar">
          <div id="show-header">
            ☰
          </div>
          <h1 id="mini-logo">
            <a href="../"><p class="travis">Travis</p><p>Athougies</p></a>
          </h1>
        </div>
        <div id="gallery-modal" class="modal" style="display: hidden">
          <a href="#" id="gallery-prev"></a>
          <a href="#" id="gallery-next"></a>
          <img id="gallery-image" src="#" />
          <div id="gallery-caption">
            <span class="gallery-figure">Figure <span id="figure-number">0</span> &mdash;</span><span id="caption-text"></span>
          </div>
        </div>
        <div id="header">
            <h1 id="logo">
                <a href="../"><p class="travis">Travis</p><p>Athougies</p></a>
            </h1>
            <div id="taglines">
              technologist
              dreamer
              builder
            </div>
            <ul id="navigation">
              <li><h2>Navigation</h2>
                <ul>
                  <li><a href="../">Home</a></li>
                  <li><a href="../about.html">About</a></li>
                  <li><a href="../projects.html">Projects</a></li>
                  <li><a href="../contact.html">Contact</a></li>
                  <li><a href="../archive.html">Archive</a></li>
                </ul></li>
              <li><h2>Tags</h2>
                <ul>
                
                  <li><a href="../tags/haskell.html">haskell (16)</a></li>
                
                  <li><a href="../tags/hydroponics.html">hydroponics (9)</a></li>
                
                  <li><a href="../tags/sustainability.html">sustainability (5)</a></li>
                
                  <li><a href="../tags/gardening.html">gardening (4)</a></li>
                
                  <li><a href="../tags/math.html">math (3)</a></li>
                
                  <li><a href="../tags/beam.html">beam (3)</a></li>
                
                  <li><a href="../tags/web.html">web (2)</a></li>
                
                  <li><a href="../tags/type theory.html">type theory (1)</a></li>
                
                  <li><a href="../tags/physics.html">physics (1)</a></li>
                
                  <li><a href="../tags/hakyll.html">hakyll (1)</a></li>
                
                  <li><a href="../tags/food.html">food (1)</a></li>
                
                  <li><a href="../tags/finance.html">finance (1)</a></li>
                
                  <li><a href="../tags/databases.html">databases (1)</a></li>
                
                  <li><a href="../tags/business.html">business (1)</a></li>
                
                  <li><a href="../tags/agriculture.html">agriculture (1)</a></li>
                
                  <li><a href="../tags/HoTT.html">HoTT (1)</a></li>
                </ul></li>
            </ul>
          <div id="shamelessplug">
              Site proudly generated by
              <a href="http://jaspervdj.be/hakyll">Hakyll</a> <p></p>
              This site kept updated by <a href="http://travis-ci.org">Travis CI</a> <p></p>
              <img src="https://travis-ci.org/tathougies/travis-athougies-blog.svg?branch=master" />
          </div>
        </div>

        <div id="content">
            <h1>Fun with Haskell</h1>

            <div class="info">
    Posted on <span class="date">January  6, 2015</span>
    
        by <span class="author">Travis Athougies</span>
    
</div>
<div class="tags">
  in
  <ul>
    
    <li><a href="../tags/haskell.html">haskell</a></li>
    
  </ul>
</div>



<div id="post">
<p>As I was working on some projects in Haskell (a new Haskell web framework to be exact), I stumbled
across a seemingly impossible Haskell problem. I wanted to write a function, let’s call it
<code>monadifyFirstArg</code> that took any function of the form</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ot">f ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> a1 <span class="ot">-&gt;</span> a2 <span class="ot">-&gt;</span> <span class="op">...</span> <span class="ot">-&gt;</span> an <span class="ot">-&gt;</span> m r</span></code></pre></div>
<p>and converted it into one of the form</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ot">f ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> m a1 <span class="ot">-&gt;</span> a2 <span class="ot">-&gt;</span> <span class="op">...</span> <span class="ot">-&gt;</span> an <span class="ot">-&gt;</span> m r</span></code></pre></div>
<p>Instead of taking in the parameter <code>a1</code> directly, this new function would take a monadic action that
returns this parameter (let’s call it <code>mkA1</code>) , and then the rest of the arguments. When the
resulting monadic action is invoked, the result would first run <code>mkA1</code> and then pass the output to
the original <code>f</code>, before passing in all the remaining arguments.</p>
<p>This seems like a pretty easy function to write, because a human could do it quite simply. If I
asked you to write this function, for some <code>f</code>, you would be able to rattle it off:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ot">f ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> a1 <span class="ot">-&gt;</span> a2 <span class="ot">-&gt;</span> <span class="op">...</span> <span class="ot">-&gt;</span> an <span class="ot">-&gt;</span> m r</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ot">monadifiedF ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> m a1 <span class="ot">-&gt;</span> a2 <span class="ot">-&gt;</span> <span class="op">...</span> <span class="ot">-&gt;</span> an <span class="ot">-&gt;</span> m r</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>monadifiedF mkA1 a2 <span class="op">...</span> an<span class="ot">=</span> <span class="kw">do</span> a1 <span class="ot">&lt;-</span> mkA1</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                               f a1 a2 <span class="op">...</span> an</span></code></pre></div>
<p>But, in this problem, we want the compiler to be able to do this for us. Namely, we want to write a
function <code>monadifyFirstArg</code> such that <code>monadifyFirstArg f = monadifiedF</code> (this isn’t a formal
semantic, but just something to get our thinking juices flowing). What would the type of this
function be? Intuitively, it should be something like</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ot">monadifyFirstArg ::</span> (a1 <span class="ot">-&gt;</span> <span class="op">....</span> <span class="ot">-&gt;</span> m r) <span class="ot">-&gt;</span> m a1 <span class="ot">-&gt;</span> <span class="op">...</span> <span class="ot">-&gt;</span> m r</span></code></pre></div>
<p>Needless to say, however, this isn’t valid Haskell.</p>
<p>What do we do now? Let’s try to write out the idealized type signature fully parenthesized</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ot">monadifyFirstArg ::</span> (a1 <span class="ot">-&gt;</span> (a2 <span class="ot">-&gt;</span> (<span class="op">...</span> (an <span class="ot">-&gt;</span> mr)))) <span class="ot">-&gt;</span> (a2 <span class="ot">-&gt;</span> (<span class="op">...</span> (an <span class="ot">-&gt;</span> mr)))</span></code></pre></div>
<p>Aha! This sheds some light on the situation.If you notice, the two parenthesized expressions (<code>(a2 -&gt; (... (an -&gt; mr)))</code>) are the result of functions (the function passed in as the first parameter
and the output of the <code>monadifyFirstArg</code> function). This means that the entire type can be replaced
by a type variable. Let’s call this type variable <code>o</code>. Now, we can write</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>monadifyFirstArg<span class="op">:</span> (a1 <span class="ot">-&gt;</span> o) <span class="ot">-&gt;</span> m a1 <span class="ot">-&gt;</span> o</span></code></pre></div>
<p>But this loses some meaning. Namely, we want to constrain <code>o</code> to only being types of the form <code>a2 -&gt; ... -&gt; m r</code>. What’s the standard Haskell solution to constraining types to a certain form? You
guessed it, type classes!</p>
<div class="large-quote"><span class="quote-content">
What’s the standard Haskell solution to constraining types for a certain form? You guessed it,
<strong><em>type classes!</em></strong></span><span class="quote-source"></span></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="dt">ResultsInMonad</span> o</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">ResultsInMonad</span> (m o)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">ResultsInMonad</span> b <span class="ot">=&gt;</span> <span class="dt">ResultsInMonad</span> (a <span class="ot">-&gt;</span> b)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="ot">monadifyFirstArg ::</span> <span class="dt">ResultsInMonad</span> o <span class="ot">=&gt;</span> (a1 <span class="ot">-&gt;</span> o) <span class="ot">-&gt;</span> m a1 <span class="ot">-&gt;</span> o</span></code></pre></div>
<p>Great! By constraining <code>o</code> to be a member of the <code>ResultsInMonad</code> class, we can now place
restrictions on the form of its type. We create two instances of <code>ResultsInMonad</code>. The first
instance <code>Monad m =&gt; ResultsInMonad (m o)</code> means that any pure monadic action results in a monad. This
allows the Haskell compiler to verify that <code>monadifyFirstArg :: (a1 -&gt; m r) -&gt; m a1 -&gt; m r</code> is a
valid. The sceond instance says that any function whose result eventually results in a monad is also
an instance of <code>ResultsInMonad</code>. So far, so good!</p>
<p>There is only one problem however. The monad <code>m</code> in the <code>ResultsInMonad (m o)</code> can be any monad
whatsoever. That is, <code>IO a</code> is a valid instance and so is <code>ST a</code> and <code>Maybe a</code> and <code>[a]</code>. This means
that the following is a valid type for <code>monadifyFirstArg</code></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ot">monadifyFirstArg ::</span> (a1 <span class="ot">-&gt;</span> a2 <span class="ot">-&gt;</span> <span class="dt">Maybe</span> r) <span class="ot">-&gt;</span> <span class="dt">IO</span> a1 <span class="ot">-&gt;</span> a2 <span class="ot">-&gt;</span> <span class="dt">Maybe</span> r</span></code></pre></div>
<p>Uh oh! This isn’t what we wanted, we need some way to constrain that the monad in question is a
certain type. We can do this by adding a parameter to the <code>ResultsinMonad</code> class (and enable a few
GHC extensions)</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE MultiParamTypeClasses, FlexibleInstances, KindSignatures #-}</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="dt">ResultsInMonad</span> o m</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">ResultsInMonad</span> (m o) m</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">ResultsInMonad</span> b m <span class="ot">=&gt;</span> <span class="dt">ResultsInMonad</span> (a <span class="ot">-&gt;</span> b) m</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="ot">monadifyFirstArg ::</span> <span class="dt">ResultsInMonad</span> o m <span class="ot">=&gt;</span> (a1 <span class="ot">-&gt;</span> o) <span class="ot">-&gt;</span> m a1 <span class="ot">-&gt;</span> o</span></code></pre></div>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'travisathougiessblog'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

        </div>
        <!-- Google Analytics Tracking -->
        <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-55204994-1', 'auto');
        ga('send', 'pageview');

        </script>
    </body>
</html>
